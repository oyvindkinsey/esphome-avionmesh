<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Avionmesh</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#1a1a2e;color:#e0e0e0;padding:12px;max-width:800px;margin:0 auto}
h1{font-size:1.3em;margin-bottom:8px;color:#64b5f6}
h2{font-size:1.1em;margin:16px 0 8px;color:#90caf9;border-bottom:1px solid #333;padding-bottom:4px}
.status-bar{background:#252547;padding:8px 12px;border-radius:6px;margin-bottom:12px;display:flex;gap:16px;flex-wrap:wrap;font-size:.85em}
.status-bar .s{opacity:.7}
.status-bar .v{font-weight:600}
.ble-ok{color:#66bb6a}.ble-bad{color:#ef5350}
section{background:#252547;border-radius:6px;padding:12px;margin-bottom:12px}
button{background:#1565c0;color:#fff;border:none;padding:6px 14px;border-radius:4px;cursor:pointer;font-size:.85em}
button:hover{background:#1976d2}
button:disabled{opacity:.5;cursor:not-allowed}
button.danger{background:#c62828}button.danger:hover{background:#d32f2f}
button.sm{padding:3px 8px;font-size:.8em}
input,select{background:#1a1a2e;color:#e0e0e0;border:1px solid #444;padding:5px 8px;border-radius:4px;font-size:.85em}
input:focus,select:focus{outline:none;border-color:#64b5f6}
table{width:100%;border-collapse:collapse;font-size:.85em}
th{text-align:left;padding:4px 6px;color:#90caf9;border-bottom:1px solid #444}
td{padding:4px 6px;border-bottom:1px solid #333}
.controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.slider{width:100px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
.msg{padding:6px;border-radius:4px;margin:6px 0;font-size:.85em}
.msg-ok{background:#1b5e20;color:#a5d6a7}.msg-err{background:#b71c1c;color:#ef9a9a}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #666;border-top-color:#64b5f6;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none}
.tag{display:inline-block;background:#37474f;padding:1px 6px;border-radius:3px;font-size:.8em;margin:1px}
#eventFeed{max-height:200px;overflow-y:auto;font-family:monospace;font-size:.8em;line-height:1.5}
#eventFeed div{padding:2px 4px;border-bottom:1px solid #333}
.sse-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:6px}
.sse-on{background:#66bb6a}.sse-off{background:#ef5350}
</style>
</head>
<body>
<h1>Avionmesh Manager</h1>

<div class="status-bar" id="statusBar">
  <span><span class="s">BLE:</span> <span id="bleState" class="v">--</span></span>
  <span><span class="s">Devices:</span> <span id="devCount" class="v">0</span></span>
  <span><span class="s">Groups:</span> <span id="grpCount" class="v">0</span></span>
  <span><span class="s">RX:</span> <span id="rxCount" class="v">0</span></span>
  <span><span class="s">SSE:</span> <span id="sseDot" class="sse-dot sse-off"></span></span>
</div>

<section>
<h2>Setup</h2>
<div class="row">
  <input id="cloudEmail" placeholder="Avi-on email" style="width:160px">
  <input id="cloudPass" type="password" placeholder="Password" style="width:120px">
  <button onclick="cloudImport()">Import from Cloud</button>
</div>
<div class="row" style="margin-top:8px">
  <input id="newPassphrase" type="password" placeholder="Base64 passphrase (â‰¥16 decoded)" style="width:240px">
  <button onclick="setPassphrase()">Set Passphrase</button>
  <button onclick="generatePassphrase()">Generate New</button>
</div>
<div class="row" style="margin-top:8px">
  <button class="danger" onclick="factoryReset()">Factory Reset (Clear All)</button>
</div>
<div id="setupMsg"></div>
</section>

<section>
<h2>Scan &amp; Add Devices</h2>
<div class="row">
  <button onclick="startMeshScan()" id="btnMeshScan">Mesh Ping Scan</button>
  <button onclick="startUnassocScan()" id="btnUnassocScan">Unassociated Scan</button>
</div>
<div id="scanMsg"></div>
<table id="scanResults" class="hidden">
<thead><tr><th>ID</th><th>FW</th><th>Vendor</th><th>Product</th><th>Status</th><th></th></tr></thead>
<tbody id="scanBody"></tbody>
</table>
<div id="unassocResults" class="hidden">
  <h3 style="font-size:.9em;margin:8px 0 4px">Unassociated Devices</h3>
  <div id="unassocList"></div>
</div>
</section>

<section>
<h2>Devices</h2>
<table id="deviceTable">
<thead><tr><th>ID</th><th>Name</th><th>Product</th><th>State</th><th>Controls</th><th></th></tr></thead>
<tbody id="deviceBody"></tbody>
</table>
</section>

<section>
<h2>Groups</h2>
<div class="row" style="margin-bottom:8px">
  <input id="newGrpName" placeholder="Group name" style="width:140px">
  <button onclick="createGroup()">Create Group</button>
</div>
<table id="groupTable">
<thead><tr><th>ID</th><th>Name</th><th>Controls</th><th>Members</th><th>Add Member</th><th></th></tr></thead>
<tbody id="groupBody"></tbody>
</table>
</section>

<section>
<h2>Event Feed</h2>
<div id="eventFeed"></div>
</section>

<script>
const API = '/avionmesh/api/';
let devices = [], groups = [], bleState = 0;
let unassocHashes = [];
let claimingHash = null;

const BLE_NAMES = ['Idle','Scanning','Connecting','Discovering','Ready','Disconnected'];
const PRODUCTS = [
  {v:0,n:'Group'},{v:90,n:'Lamp Dimmer'},{v:93,n:'Recessed DL'},
  {v:94,n:'Light Adapter'},{v:97,n:'Smart Dimmer'},{v:134,n:'Smart Bulb'},
  {v:137,n:'Surface DL'},{v:162,n:'Micro Edge'},{v:167,n:'Smart Switch'}
];

function $(id){return document.getElementById(id)}
async function api(path,opts){
  const r=await fetch(API+path,opts);
  if(!r.ok){
    const err=await r.json().catch(()=>({error:r.statusText}));
    const msg=err.error||err.message||'API error '+r.status;
    // User-friendly error messages
    if(msg==='mesh_not_initialized')throw new Error('Mesh not initialized - set a passphrase first');
    if(msg==='ble_not_ready')throw new Error('BLE not ready - check connection status');
    throw new Error(msg);
  }
  return r.json();
}
async function postJson(path,data){return api(path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})}

function showMsg(el,text,ok){
  el.className='msg '+(ok?'msg-ok':'msg-err');
  el.textContent=text;
  setTimeout(()=>el.textContent='',5000);
}

function productSelect(selected){
  let h='<select class="prod-sel">';
  PRODUCTS.forEach(p=>{
    if(p.v===0) return;
    h+=`<option value="${p.v}"${p.v===selected?' selected':''}>${p.n}</option>`;
  });
  return h+'</select>';
}

function feedLog(text){
  const feed=$('eventFeed');
  const d=document.createElement('div');
  const ts=new Date().toLocaleTimeString();
  d.textContent=ts+' '+text;
  feed.prepend(d);
  while(feed.children.length>50) feed.lastChild.remove();
}

/* ---- SSE ---- */
let evtSource = null;

function connectSSE(){
  if(evtSource) evtSource.close();
  evtSource = new EventSource(API+'events');

  evtSource.onopen = ()=>{
    $('sseDot').className='sse-dot sse-on';
    feedLog('SSE connected');
  };

  evtSource.onerror = ()=>{
    $('sseDot').className='sse-dot sse-off';
  };

  evtSource.addEventListener('discover_mesh', e=>{
    const d=JSON.parse(e.data);
    $('btnMeshScan').disabled=false;
    $('btnMeshScan').textContent='Mesh Ping Scan';
    renderScanResults(d.devices||[]);
    feedLog('Mesh scan: '+((d.devices||[]).length)+' device(s) found');
  });

  evtSource.addEventListener('scan_unassoc', e=>{
    const d=JSON.parse(e.data);
    $('btnUnassocScan').disabled=false;
    $('btnUnassocScan').textContent='Unassociated Scan';
    renderUnassoc(d.uuid_hashes||[]);
    feedLog('Unassoc scan: '+((d.uuid_hashes||[]).length)+' device(s)');
  });

  evtSource.addEventListener('claim_result', e=>{
    const d=JSON.parse(e.data);
    feedLog('Claim result: '+(d.status==='ok'?'assigned ID '+d.device_id:d.message||'failed'));
    if(d.status==='ok' && claimingHash){
      const idx = unassocHashes.indexOf(claimingHash);
      if(idx >= 0){
        const row = $('unassocRow'+idx);
        if(row) row.remove();
        unassocHashes.splice(idx,1);
      }
      claimingHash = null;
    }
    setTimeout(refreshStatus,1000);
  });

  evtSource.addEventListener('examine', e=>{
    const d=JSON.parse(e.data);
    const res=$('exRes'+d.avion_id);
    const btn=$('exBtn'+d.avion_id);
    if(btn) btn.disabled=false;
    if(res){
      if(d.error)
        res.innerHTML='<span style="color:#ef5350">'+d.error+'</span>';
      else
        res.innerHTML=`FW ${d.fw} | Vendor ${d.vendor_id} | CSR ${d.csr_product_id} | Flags ${d.flags}`;
      setTimeout(()=>res.textContent='',15000);
    }
    feedLog('Examine #'+d.avion_id+': '+(d.error||'ok'));
  });

  evtSource.addEventListener('debug', e=>{
    const d=JSON.parse(e.data);
    feedLog('DEBUG: '+e.data);
  });

  evtSource.addEventListener('state', e=>{
    const d=JSON.parse(e.data);
    // Update local state
    const dev=devices.find(x=>x.avion_id===d.avion_id);
    if(dev){
      dev.brightness=d.brightness;
      if(d.color_temp!==undefined) dev.color_temp=d.color_temp;
      renderDevices();
    }
    const name=dev?dev.name:'#'+d.avion_id;
    let info=name+': brightness='+d.brightness;
    if(d.color_temp!==undefined) info+=' ct='+d.color_temp+'K';
    feedLog(info);
  });
}

/* ---- Status (initial load + periodic refresh for device/group list) ---- */
async function refreshStatus(){
  try{
    const d=await api('status');
    bleState=d.ble_state;
    devices=d.devices||[];
    groups=d.groups||[];
    const bs=$('bleState');
    bs.textContent=BLE_NAMES[d.ble_state]||'?';
    bs.className='v '+(d.ble_state===4?'ble-ok':'ble-bad');
    $('devCount').textContent=devices.length;
    $('grpCount').textContent=groups.length;
    $('rxCount').textContent=d.rx_count;
    renderDevices();
    renderGroups();
  }catch(e){
    $('bleState').textContent='Error';
    $('bleState').className='v ble-bad';
  }
}

function renderDevices(){
  const tb=$('deviceBody');
  if(!devices.length){tb.innerHTML='<tr><td colspan="6" style="opacity:.5">No devices</td></tr>';return}
  let h='';
  devices.forEach(d=>{
    const dim=d.brightness!==undefined;
    const ct=d.color_temp!==undefined;
    const on=dim&&d.brightness>0;
    const state=dim?`${on?'ON':'OFF'} (${d.brightness})`+(ct?` ${d.color_temp}K`:''):'--';
    h+=`<tr>
      <td>${d.avion_id}</td>
      <td>${esc(d.name)}</td>
      <td>${esc(d.product_name)}</td>
      <td>${state}</td>
      <td class="controls">
        <button class="sm" onclick="ctrlDev(${d.avion_id},255)">On</button>
        <button class="sm" onclick="ctrlDev(${d.avion_id},0)">Off</button>
        <input type="range" class="slider" min="0" max="255" value="${d.brightness||0}"
          onchange="ctrlDev(${d.avion_id},+this.value)">
      </td>
      <td>
        <button class="sm" id="exBtn${d.avion_id}" onclick="examDev(${d.avion_id})">Examine</button>
        <button class="sm danger" onclick="removeDev(${d.avion_id})">Remove</button>
        <div id="exRes${d.avion_id}" style="font-size:.8em;margin-top:2px"></div>
      </td>
    </tr>`;
  });
  tb.innerHTML=h;
}

function ctrlControls(id){
  return `<button class="sm" onclick="ctrlDev(${id},255)">On</button>
    <button class="sm" onclick="ctrlDev(${id},0)">Off</button>
    <input type="range" class="slider" min="0" max="255" value="0"
      onchange="ctrlDev(${id},+this.value)">
    <input type="number" placeholder="K" style="width:60px" min="2000" max="6500"
      onchange="ctrlTemp(${id},+this.value)">`;
}

function renderGroups(){
  const tb=$('groupBody');
  let h=`<tr>
    <td>0</td>
    <td>All (Broadcast)</td>
    <td class="controls">${ctrlControls(0)}</td>
    <td colspan="2"></td>
    <td></td>
  </tr>`;
  groups.forEach(g=>{
    const members=g.members.map(mid=>{
      const d=devices.find(x=>x.avion_id===mid);
      return `<span class="tag">${d?esc(d.name):mid} <a href="#" onclick="rmFromGrp(${mid},${g.group_id});return false" style="color:#ef5350">&times;</a></span>`;
    }).join(' ');
    const devOpts=devices.filter(d=>!g.members.includes(d.avion_id))
      .map(d=>`<option value="${d.avion_id}">${esc(d.name)}</option>`).join('');
    h+=`<tr>
      <td>${g.group_id}</td>
      <td>${esc(g.name)}</td>
      <td class="controls">${ctrlControls(g.group_id)}</td>
      <td>${members||'<span style="opacity:.5">none</span>'}</td>
      <td>${devOpts?`<select id="addMbr${g.group_id}"><option value="">--</option>${devOpts}</select>
        <button class="sm" onclick="addToGrp(${g.group_id})">Add</button>`:''}</td>
      <td><button class="sm danger" onclick="delGroup(${g.group_id})">Delete</button></td>
    </tr>`;
  });
  tb.innerHTML=h;
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

async function ctrlDev(id,brightness){
  await postJson('control',{avion_id:id,brightness});
}

async function ctrlTemp(id,kelvin){
  if(kelvin) await postJson('control',{avion_id:id,color_temp:kelvin});
}

async function examDev(id){
  const btn=$('exBtn'+id);
  const res=$('exRes'+id);
  btn.disabled=true;
  res.innerHTML='<span class="spinner"></span> Examining...';
  try{
    await postJson('examine_device',{avion_id:id});
  }catch(e){
    btn.disabled=false;
    res.innerHTML='<span style="color:#ef5350">Error</span>';
  }
}

async function removeDev(id){
  if(!confirm(`Remove device ${id}?`)) return;
  await postJson('unclaim_device',{avion_id:id});
  setTimeout(refreshStatus,500);
}

async function createGroup(){
  const name=$('newGrpName').value;
  if(!name) return;
  await postJson('create_group',{name});
  $('newGrpName').value='';
  setTimeout(refreshStatus,500);
}

async function delGroup(id){
  if(!confirm(`Delete group ${id}?`)) return;
  await postJson('delete_group',{group_id:id});
  setTimeout(refreshStatus,500);
}

async function addToGrp(gid){
  const sel=$('addMbr'+gid);
  const mid=+sel.value;
  if(!mid) return;
  await postJson('add_to_group',{avion_id:mid,group_id:gid});
  setTimeout(refreshStatus,500);
}

async function rmFromGrp(mid,gid){
  await postJson('remove_from_group',{avion_id:mid,group_id:gid});
  setTimeout(refreshStatus,500);
}

/* Mesh scan */
async function startMeshScan(){
  const btn=$('btnMeshScan');
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Scanning...';
  $('scanResults').classList.remove('hidden');
  $('scanBody').innerHTML='<tr><td colspan="6"><span class="spinner"></span> Scanning mesh...</td></tr>';
  try{
    await postJson('discover_mesh',{});
  }catch(e){
    btn.disabled=false;btn.textContent='Mesh Ping Scan';
    $('scanBody').innerHTML=`<tr><td colspan="6" style="color:#ef5350">Error: ${e.message}</td></tr>`;
  }
}

function renderScanResults(devs){
  $('scanResults').classList.remove('hidden');
  const tb=$('scanBody');
  if(!devs.length){tb.innerHTML='<tr><td colspan="6" style="opacity:.5">No devices found</td></tr>';return}
  let h='';
  devs.forEach(d=>{
    h+=`<tr>
      <td>${d.device_id}</td>
      <td>${d.fw}</td>
      <td>${d.vendor_id}</td>
      <td>${d.csr_product_id}</td>
      <td>${d.known?'<span style="color:#66bb6a">Known</span>':'New'}</td>
      <td>${d.known?'':
        `<input placeholder="Name" id="sn${d.device_id}" style="width:100px" value="Device ${d.device_id}">
         ${productSelect(0)}
         <button class="sm" onclick="addScanned(${d.device_id})">Add</button>`}</td>
    </tr>`;
  });
  tb.innerHTML=h;
}

async function addScanned(did){
  const name=$('sn'+did).value||('Device '+did);
  const sel=$('sn'+did).parentElement.querySelector('.prod-sel');
  const pt=sel?+sel.value:134;
  await postJson('add_discovered',{device_id:did,name,product_type:pt});
  showMsg($('scanMsg'),'Device added','ok');
  setTimeout(refreshStatus,500);
}

/* Unassociated scan */
async function startUnassocScan(){
  const btn=$('btnUnassocScan');
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Scanning...';
  $('unassocResults').classList.remove('hidden');
  $('unassocList').innerHTML='<span class="spinner"></span> Scanning...';
  try{
    await postJson('scan_unassociated',{});
  }catch(e){
    btn.disabled=false;btn.textContent='Scan for New Devices';
    $('unassocList').innerHTML=`<span style="color:#ef5350">Error: ${e.message}</span>`;
  }
}

function renderUnassoc(hashes){
  $('unassocResults').classList.remove('hidden');
  const el=$('unassocList');
  unassocHashes = hashes;
  if(!hashes.length){el.innerHTML='<span style="opacity:.5">No unassociated devices found</span>';return}
  let h='';
  hashes.forEach((hash,i)=>{
    h+=`<div class="row" style="margin:4px 0" id="unassocRow${i}">
      <span style="font-family:monospace">${hash}</span>
      <input placeholder="Name" id="cn${i}" style="width:100px">
      ${productSelect(134)}
      <button class="sm" id="claimBtn${i}" onclick="claimDev('${hash}',${i})">Claim</button>
      <span id="claimMsg${i}" style="font-size:.8em;margin-left:6px"></span>
    </div>`;
  });
  el.innerHTML=h;
}

async function claimDev(hash,idx){
  claimingHash = hash;
  const btn=$('claimBtn'+idx);
  const msg=$('claimMsg'+idx);
  const name=$('cn'+idx).value||('Unknown Device');
  const sel=$('cn'+idx).parentElement.querySelector('.prod-sel');
  const pt=sel?+sel.value:134;
  const uuidHash=parseInt(hash,16);
  btn.disabled=true;
  btn.textContent='Claiming...';
  msg.textContent='Starting claim...';
  await postJson('claim_device',{uuid_hash:uuidHash,name,product_type:pt});
}

/* Setup functions */
async function cloudImport(){
  const email=$('cloudEmail').value, pass=$('cloudPass').value;
  const msgEl=$('setupMsg');
  if(!email||!pass){showMsg(msgEl,'Enter email and password',false);return}

  try{
    showMsg(msgEl,'Contacting Avi-on cloud (via ESP)...',true);

    // Call ESP32 to handle the import
    const result=await postJson('cloud_import',{email,password:pass});

    if(result.status!=='ok'){
      throw new Error(result.message||'Cloud import failed');
    }

    // Process the devices and groups
    const cloudDevs=(result.devices||[]).map(d=>({
      device_id:d.avion_id||d.device_id||d.id,
      name:d.name||'Device',
      product_type:d.product_id||d.product_type||134
    })).filter(d=>d.device_id>0);

    const cloudGrps=(result.groups||[]).map(g=>({
      group_id:g.avion_id||g.id,
      name:g.name||'Group',
      members:(g.abstract_devices||g.devices||[]).map(d=>d.avion_id||d.device_id||d.id).filter(Boolean)
    })).filter(g=>g.group_id>0);

    showMsg(msgEl,`Importing ${cloudDevs.length} devices, ${cloudGrps.length} groups...`,true);

    const importResult=await postJson('import',{devices:cloudDevs,groups:cloudGrps});
    showMsg(msgEl,`Import complete: ${importResult.added_devices} devices, ${importResult.added_groups} groups added`,true);
    setTimeout(refreshStatus,500);
  }catch(e){
    showMsg(msgEl,'Cloud import failed: '+e.message,false);
  }
}

async function setPassphrase(){
  const passphrase=$('newPassphrase').value;
  const msgEl=$('setupMsg');
  if(!passphrase){
    showMsg(msgEl,'Passphrase cannot be empty',false);
    return;
  }
  if(passphrase.length<8){
    showMsg(msgEl,'Passphrase must be at least 8 characters',false);
    return;
  }
  // Optional: validate base64 format (for new format)
  if(passphrase.length%4===0){
    try{
      const decoded=atob(passphrase);
      if(decoded.length<16){
        showMsg(msgEl,'Base64 passphrase must decode to at least 16 bytes (got '+decoded.length+')',false);
        return;
      }
    }catch(e){
      showMsg(msgEl,'Invalid base64 format',false);
      return;
    }
  }
  await postJson('set_passphrase',{passphrase});
  showMsg(msgEl,'Passphrase set successfully - mesh will reconnect',true);
  $('newPassphrase').value='';
}

async function generatePassphrase(){
  const msgEl=$('setupMsg');
  const res=await postJson('generate_passphrase',{});
  if(res.passphrase){
    showMsg(msgEl,'Generated: '+res.passphrase,true);
    $('newPassphrase').value='';
  }else{
    showMsg(msgEl,'Failed to generate passphrase',false);
  }
}

async function factoryReset(){
  if(!confirm('Factory reset will remove all devices, groups, and passphrase. Continue?')) return;
  const msgEl=$('setupMsg');
  await postJson('factory_reset',{});
  showMsg(msgEl,'Factory reset complete - page will reload',true);
  setTimeout(()=>location.reload(),2000);
}

// Initial load + periodic refresh for device/group list changes
refreshStatus();
setInterval(refreshStatus,30000);
connectSSE();
</script>
</body>
</html>
